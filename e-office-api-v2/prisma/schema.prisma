// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator prismabox {
  provider                    = "prismabox"
  // you can optionally specify the output location. Defaults to ./prismabox
  output                      = "../src/generated/prismabox"
  // if you want, you can customize the imported variable name that is used for the schemes. 
  // Defaults to "Type" which is what the standard typebox package offers
  typeboxImportVariableName   = "t"
  // you also can specify the dependency from which the above import should happen. 
  // This is useful if a package re-exports the typebox package and you would like to use that
  typeboxImportDependencyName = "elysia"
  // by default the generated schemes do not allow additional properties. You can allow them 
  // by setting this to true
  additionalProperties        = true
  // optionally enable the data model generation. See the data model section below for more info
  inputModel                  = true
}

// README 
// WE HAVE NAMING CONVENTION!!!!!!!!
// so untuk code agar native convention js:
// Nama tabel: PascalCase
// Nama kolom: camelCase
// tambahan semua kolom akan punya id, semua menggunakan
// cuid (string), regardless of table

// tadi untuk js, untuk database native ditujukan untuk
// memudahkan query di postgresql langsung,
// naming conventionnya berubah menjadi:
// Nama tabel: snake_case
// Nama kolom: snake_case 

// GENERATED BY BETTER-AUTH

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// END OF GENERATED BY BETTER-AUTH

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  users       UserRole[]
  permissions RolePermission[]

  @@map("role")
}

model Permission {
  id       String           @id @default(cuid())
  resource String
  action   String
  roles    RolePermission[]

  @@unique([resource, action])
  @@map("permission")
}

model UserRole {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String
  role   Role   @relation(fields: [roleId], references: [id])
  roleId String

  //weak entity
  @@unique([userId, roleId])
  @@map("user_role")
}

model RolePermission {
  id           String     @id @default(cuid())
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       String
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId String

  //weak entity
  @@unique([roleId, permissionId])
  @@map("role_permission")
}

model User {
  id String @id @default(cuid())

  name  String
  email String @unique

  emailVerified Boolean  @default(false) // punya betterauth
  image         String? // punya betterauth
  isAnonymous   Boolean? @default(false) // punya betterauth (untuk sso login)

  mahasiswa Mahasiswa?
  pegawai   Pegawai?

  userRole            UserRole[]
  sessions            Session[]
  accounts            Account[]
  LetterInstance      LetterInstance[]
  uploadedAttachments Attachment[]
  stepHistoryActions  LetterStepHistory[]
  assignedNumbering   LetterNumbering[]

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("user")
}

model Mahasiswa {
  id  String @id @default(cuid())
  nim String

  tahunMasuk   String
  noHp         String
  alamat       String?
  tempatLahir  String?
  tanggalLahir DateTime?

  userId         String        @unique
  user           User          @relation(fields: [userId], references: [id])
  departemenId   String
  departemen     Departemen?   @relation(fields: [departemenId], references: [id])
  programStudiId String
  programStudi   ProgramStudi? @relation(fields: [programStudiId], references: [id])

  @@map("mahasiswa")
}

model Pegawai {
  id      String  @id @default(cuid())
  nip     String
  jabatan String
  noHp    String?

  userId         String        @unique
  user           User          @relation(fields: [userId], references: [id])
  departemenId   String
  departemen     Departemen?   @relation(fields: [departemenId], references: [id])
  programStudiId String
  programStudi   ProgramStudi? @relation(fields: [programStudiId], references: [id])

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("pegawai")
}

model Departemen {
  id   String @id @default(cuid())
  name String
  code String @unique

  programStudi ProgramStudi[]
  pegawai      Pegawai[]
  mahasiswa    Mahasiswa[]

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("departemen")
}

enum Jenjang {
  S1
  S2
  S3
}

model ProgramStudi {
  id String @id @default(cuid())

  name String
  code String @unique

  departemenId String
  departemen   Departemen @relation(fields: [departemenId], references: [id])

  pegawai   Pegawai[]
  mahasiswa Mahasiswa[]

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("program_studi")
}

model Attachment {
  id String @id @default(cuid())

  domain   String
  filename String

  // Relasi ke surat
  letterId String?
  letter   LetterInstance? @relation(fields: [letterId], references: [id], onDelete: Cascade)

  // Metadata
  category         String?  // "PROPOSAL", "KTM", "LAMPIRAN_TAMBAHAN", dll
  uploadedByUserId String?
  uploadedBy       User?    @relation(fields: [uploadedByUserId], references: [id])
  isActive         Boolean  @default(true)

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@index([letterId])
  @@map("attachment")
}

model LetterType {
  id          String  @id @default(cuid())
  name        String
  description String?

  templates      LetterTemplate[]
  letterInstance LetterInstance[]

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("letter_type")
}

model LetterTemplate {
  id String @id @default(cuid())

  versionName      String @map("version_name")
  schemaDefinition Json   @map("schema_defintion")
  formFields       Json   @map("form_fields")

  letterTypeId String     @map("letter_type_id")
  LetterType   LetterType @relation(fields: [letterTypeId], references: [id])

  @@map("letter_template")
}

enum FieldType {
  STRING
  NUMBER
  DATE
  FILE
  BOOLEAN
  ENUM

  @@map("field_type")
}

model LetterInstance {
  id String @id @default(cuid())

  schema      Json
  values      Json
  status      LetterStatus @default(DRAFT)
  currentStep Int?

  // Metadata workflow (JSON untuk flexibility)
  assignedApprovers     Json?  // { dospem: userId, koordinator: userId, ... }
  documentVersions      Json   @default("[]")  // [{ version, storageKey, format, ... }, ...]
  latestEditableVersion Int    @default(1)
  latestPDFVersion      Int?

  // Milestone (denormalisasi untuk query cepat)
  signedAt     DateTime?
  signatureUrl String?

  letterTypeId String
  letterType   LetterType @relation(fields: [letterTypeId], references: [id])
  createdById  String
  createdBy    User       @relation(fields: [createdById], references: [id])

  // Relasi (1-to-many)
  attachments   Attachment[]
  stepHistory   LetterStepHistory[]
  numbering     LetterNumbering?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("letter_instance")
}

model LetterStepHistory {
  id String @id @default(cuid())

  letterId String
  letter   LetterInstance @relation(fields: [letterId], references: [id], onDelete: Cascade)

  // Aksi yang dilakukan
  action String  // "SUBMITTED", "APPROVED", "REJECTED", "REVISED", "SELF_REVISED", "CANCELLED", "EDITED", "SIGNED", "NUMBERED"

  // Step workflow (nullable untuk aksi mahasiswa: submit/cancel/self-revise)
  step Int?  // 1=Dospem, 2=Koordinator, ..., 9=UPA

  // Actor
  actorUserId String
  actor       User   @relation(fields: [actorUserId], references: [id])
  actorRole   String  // "mahasiswa", "dosen_pembimbing", dll

  // Detail aksi
  comment String?  // Komentar (wajib untuk reject/revise)

  // Transisi step (untuk tracking rollback)
  fromStep Int?
  toStep   Int?

  // Metadata tambahan (untuk aksi khusus)
  metadata Json?  // { documentVersion, signatureUrl, letterNumber, dll }

  createdAt DateTime @default(now())

  @@index([letterId])
  @@index([actorUserId])
  @@index([action])
  @@index([createdAt])
  @@map("letter_step_history")
}

model LetterNumbering {
  id String @id @default(cuid())

  letterId String         @unique
  letter   LetterInstance @relation(fields: [letterId], references: [id], onDelete: Cascade)

  // Komponen nomor
  letterTypeCode String   // "AK15" untuk PKL
  date           DateTime  // Tanggal penomoran (untuk grouping counter)
  counter        Int      // Counter per tanggal (1, 2, 3, ...)

  // Nomor final (untuk display + search)
  numberString String @unique  // "AK15-01/22/01/2026" (UNIQUE CONSTRAINT!)

  // Metadata
  assignedByUserId String
  assignedBy       User   @relation(fields: [assignedByUserId], references: [id])

  createdAt DateTime @default(now())

  @@unique([letterTypeCode, date, counter])
  @@index([numberString])
  @@index([date])
  @@map("letter_numbering")
}

enum LetterStatus {
  DRAFT       // Surat belum di-submit
  PROCESSING  // Surat sedang dalam workflow approval
  COMPLETED   // Terminal: surat selesai (sudah dinomori)
  REJECTED    // Terminal: surat ditolak
  CANCELLED   // Terminal: surat dibatalkan mahasiswa

  @@map("letter_status")
}

enum StepStatus {
  DRAFT
  ACCEPTED
  VERIFIED
  REJECTED
  REVISION

  @@map("step_status")
}

enum TemplateEngine {
  HANDLEBARS
  RAW

  @@map("template_engine")
}

// model Jwks {
//   id         String    @id
//   publicKey  String
//   privateKey String
//   createdAt  DateTime
//   expiresAt  DateTime?

//   @@map("jwks")
// }
